<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">

    <!--======================== Changes #1 ========================-->
    <changeSet id="1" author="viktorp">
        <comment>Changed companies.id type from long to int</comment>
        
        <sql splitStatements="false">
            ALTER TABLE companies ALTER COLUMN id SET DATA TYPE integer;
            ALTER TABLE contacts ALTER COLUMN company_id SET DATA TYPE integer;
            ALTER TABLE users ALTER COLUMN company_id SET DATA TYPE integer;

            CREATE SEQUENCE companies_id_seq OWNED BY companies.id;
            SELECT setval('companies_id_seq', coalesce(max(id), 0) + 1) FROM companies;
            ALTER TABLE companies ALTER COLUMN id SET DEFAULT nextval('companies_id_seq');
        </sql>
    </changeSet>


    <!--===== This changeset MUST always be at the end of the file !!! =====-->
    <changeSet id="0" author="viktorp" runAlways="true">
        <comment>Ensure that admin user has proper rights on all tables</comment>
        
        <sql splitStatements="false">
            GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO admin;
            GRANT USAGE, SELECT, UPDATE ON ALL SEQUENCES IN SCHEMA public TO admin;
        </sql>
    </changeSet>

</databaseChangeLog>
